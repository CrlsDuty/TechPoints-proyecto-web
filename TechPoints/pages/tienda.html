<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Zona Tienda</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase DEBE cargarse primero (sin defer para inicializaci√≥n inmediata) -->
  <script src="../assets/vendor/supabase.min.js"></script>
  <script src="../assets/js/supabaseClient.js"></script>
  <!-- Scripts: utilidades -> servicios -> app (con defer para esperar DOM) -->
  <script defer src="../assets/js/utils.js"></script>
  <script defer src="../assets/js/services/StorageService.js"></script>
  <script defer src="../assets/js/services/ValidationService.js"></script>
  <script defer src="../assets/js/services/EventEmitter.js"></script>
  <script defer src="../assets/js/services/TransactionService.js"></script>
  <script defer src="../assets/js/services/ImageStorageService.js"></script>
  <script defer src="../assets/js/authservice.js"></script>
  <script defer src="../assets/js/productService.js"></script>
  <script defer src="../assets/js/storeService.js"></script>
  <script defer src="../assets/js/app.js"></script>
</head>
<body>
  <div class="tienda-layout">
    <!-- SIDEBAR IZQUIERDA: Perfil y acciones r√°pidas -->
    <aside class="tienda-sidebar">
      <!-- Encabezado -->
      <div class="tienda-header">
        <h1>Zona Tienda</h1>
      </div>

      <!-- Perfil operativo de la tienda -->
      <section id="tiendaPerfil" class="tienda-profile" aria-live="polite">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
          <h2 style="margin: 0;">Perfil</h2>
          <button id="btnEditarPerfil" type="button" class="btn-editar-perfil">‚úèÔ∏è</button>
        </div>
        <div class="tienda-profile-body">
          <p class="tienda-nombre">Cargando...</p>
          <p class="tienda-direccion"></p>
          <p class="tienda-telefono"></p>
          <p class="tienda-horario"></p>
          <p class="tienda-responsable"></p>
        </div>
      </section>

      <!-- Acciones r√°pidas -->
      <section class="tienda-actions">
        <h3>Acciones R√°pidas</h3>
        <form id="formTiendaSidebar" class="form-compacto">
          <label for="clienteSidebar">Email del cliente:</label>
          <input type="email" id="clienteSidebar" placeholder="ana@mail.com">
          <label for="puntosSidebar">Puntos:</label>
          <input type="number" id="puntosSidebar" placeholder="50" min="1">
          <button type="submit" class="btn-secondary">Agregar Puntos</button>
        </form>
        <p id="mensajeSidebar" class="mensaje-compacto"></p>
      </section>

      <!-- Bot√≥n de cierre sesi√≥n -->
      <button onclick="logout()" class="btn-logout">üö™ Cerrar sesi√≥n</button>
    </aside>

    <!-- MAIN: Contenido principal -->
    <main class="tienda-main">
      <!-- Formulario de producto -->
      <section class="tienda-section">
        <h2>üì¶ Agregar Producto</h2>
        <form id="formProducto" class="form-producto">
          <div class="form-row">
            <div class="form-col">
              <label for="nombreProd">Nombre del producto:</label>
              <input type="text" id="nombreProd" required>
            </div>
            <div class="form-col">
              <label for="precioDolarProd">Precio en d√≥lares (USD):</label>
              <input type="number" id="precioDolarProd" step="0.01" min="0.01" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label>Costo en puntos (calculado autom√°ticamente):</label>
              <div id="costoPuntosPreview" style="padding: 10px; background-color: #f0f0f0; border-radius: 6px; border: 1px solid #d0d0d0; text-align: center; font-weight: bold; color: #333;">
                0 puntos
              </div>
            </div>
            <div class="form-col">
              <label for="stockProd">Stock disponible:</label>
              <input type="number" id="stockProd" min="0" value="0">
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label for="categoriaProd">Categor√≠a:</label>
              <select id="categoriaProd" required>
                <option value="">-- Selecciona una categor√≠a --</option>
                <optgroup label="Hardware (Componentes Internos)">
                  <option value="Procesadores (CPU)">Procesadores (CPU)</option>
                  <option value="Placas Madre">Placas Madre</option>
                  <option value="Memoria RAM">Memoria RAM</option>
                  <option value="Tarjetas Gr√°ficas (GPU)">Tarjetas Gr√°ficas (GPU)</option>
                  <option value="Almacenamiento (SSD/HDD)">Almacenamiento (SSD/HDD)</option>
                  <option value="Fuentes de Poder (PSU)">Fuentes de Poder (PSU)</option>
                  <option value="Tarjetas de Sonido/Red">Tarjetas de Sonido/Red</option>
                  <option value="Gabinetes">Gabinetes (Cajas)</option>
                  <option value="Otros - Hardware Internos">Otros - Hardware Internos</option>
                </optgroup>
                <optgroup label="Perif√©ricos (Entrada)">
                  <option value="Teclados">Teclados</option>
                  <option value="Ratones (Mouse)">Ratones (Mouse)</option>
                  <option value="C√°maras Web">C√°maras Web</option>
                  <option value="Micr√≥fonos">Micr√≥fonos</option>
                  <option value="Auriculares/Aud√≠fonos">Auriculares/Aud√≠fonos</option>
                  <option value="Otros - Perif√©ricos Entrada">Otros - Perif√©ricos Entrada</option>
                </optgroup>
                <optgroup label="Perif√©ricos (Salida)">
                  <option value="Monitores/Pantallas">Monitores/Pantallas</option>
                  <option value="Impresoras">Impresoras</option>
                  <option value="Altavoces/Parlantes">Altavoces/Parlantes</option>
                  <option value="Otros - Perif√©ricos Salida">Otros - Perif√©ricos Salida</option>
                </optgroup>
                <optgroup label="Tipos de Computadoras">
                  <option value="Computadoras Escritorio">Computadoras Escritorio</option>
                  <option value="Laptops/Notebooks">Laptops/Notebooks</option>
                  <option value="Todo en Uno (All-in-One)">Todo en Uno (All-in-One)</option>
                  <option value="Mini PCs y Barebones">Mini PCs y Barebones</option>
                  <option value="Gaming/Workstations">Gaming/Workstations (Alto rendimiento)</option>
                  <option value="Otros - Tipos de Computadoras">Otros - Tipos de Computadoras</option>
                </optgroup>
                <optgroup label="Software y Sistemas">
                  <option value="Sistemas Operativos">Sistemas Operativos</option>
                  <option value="Software de Productividad">Software de Productividad</option>
                  <option value="Otros - Software">Otros - Software</option>
                </optgroup>
                <optgroup label="Accesorios y Conectividad">
                  <option value="Cables y Adaptadores">Cables y Adaptadores</option>
                  <option value="Soportes y Bases">Soportes y Bases</option>
                  <option value="Componentes de Red">Componentes de Red (Router, Switch, etc.)</option>
                  <option value="UPS y Protectores">UPS y Protectores de Sobretensi√≥n</option>
                  <option value="Otros - Accesorios">Otros - Accesorios</option>
                </optgroup>
                <optgroup label="Mantenimiento">
                  <option value="Kits de Limpieza">Kits de Limpieza</option>
                  <option value="Ventiladores y Refrigeraci√≥n">Ventiladores y Refrigeraci√≥n</option>
                  <option value="Otros - Mantenimiento">Otros - Mantenimiento</option>
                </optgroup>
              </select>
            </div>
            <div class="form-col">
              <label for="imagenProdFile">Imagen del producto:</label>
              <input type="file" id="imagenProdFile" accept="image/*">
              <div id="imagenProdPreview" style="margin-top:8px;"></div>
              <button type="button" id="imagenProdClear" class="btn-secondary" style="margin-top:6px; display:none;">Limpiar imagen</button>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col" style="grid-column: 1 / -1;">
              <label for="descripcionProd">Descripci√≥n:</label>
              <textarea id="descripcionProd" rows="3" maxlength="200" placeholder="Describe brevemente el producto..."></textarea>
            </div>
          </div>

          <button type="submit" class="btn-primary">‚ûï Agregar Producto</button>
        </form>
      </section>

      <!-- Lista de productos -->
      <section class="tienda-section">
        <h2>üìã Mis Productos</h2>
        <div class="productos-tienda-list">
          <ul id="listaProductos"></ul>
        </div>
      </section>

      <!-- Historial de canjes de la tienda -->
      <section class="tienda-section">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <h2>üïò Historial de Canjes</h2>
          <div class="historial-controls" style="display:flex; gap:8px; align-items:center;">
            <input id="filtroBusqueda" type="search" placeholder="Buscar producto o cliente" style="padding:8px 10px; border-radius:6px; border:1px solid #d0d0d0;">
            <input id="filtroDesde" type="date" title="Desde" style="padding:8px 10px; border-radius:6px; border:1px solid #d0d0d0;">
            <input id="filtroHasta" type="date" title="Hasta" style="padding:8px 10px; border-radius:6px; border:1px solid #d0d0d0;">
            <button id="btnExportCSV" class="btn-secondary" type="button">Exportar CSV</button>
          </div>
        </div>
        <div class="historial-tienda-list">
          <ul id="historialCanjesTienda"></ul>
        </div>
      </section>

      <!-- Reportes y Estad√≠sticas -->
      <section class="tienda-section">
        <h2>üìä Reportes y Estad√≠sticas</h2>
        
        <!-- Controles de per√≠odo -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
          <label for="reportePeriodo">Per√≠odo:</label>
          <select id="reportePeriodo" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d0d0d0; font-size: 0.95em;">
            <option value="7">√öltimos 7 d√≠as</option>
            <option value="30">√öltimos 30 d√≠as</option>
            <option value="90">√öltimos 90 d√≠as</option>
            <option value="365">√öltimo a√±o</option>
            <option value="0">Todo el tiempo</option>
          </select>
          <button id="btnActualizarReportes" class="btn-secondary" type="button">Actualizar</button>
        </div>

        <!-- Tarjetas de estad√≠sticas clave -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div class="stats-card">
            <div class="stats-value" id="totalCanjes">0</div>
            <div class="stats-label">Total de Canjes</div>
          </div>
          <div class="stats-card">
            <div class="stats-value" id="totalPuntosDistribuidos">0</div>
            <div class="stats-label">Puntos Distribuidos</div>
          </div>
          <div class="stats-card">
            <div class="stats-value" id="totalClientes">0</div>
            <div class="stats-label">Clientes Activos</div>
          </div>
          <div class="stats-card">
            <div class="stats-value" id="productoMasVendido">-</div>
            <div class="stats-label">Producto M√°s Vendido</div>
          </div>
        </div>

        <!-- Gr√°ficos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; margin-bottom: 24px;">
          <!-- Gr√°fico de canjes por producto -->
          <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; height: 400px;">
            <h3 style="margin-top: 0; font-size: 1.1em;">Canjes por Producto</h3>
            <div style="position: relative; width: 100%; height: 320px;">
              <canvas id="chartCanjePorProducto"></canvas>
            </div>
          </div>

          <!-- Gr√°fico de tendencia temporal -->
          <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; height: 400px;">
            <h3 style="margin-top: 0; font-size: 1.1em;">Tendencia de Canjes</h3>
            <div style="position: relative; width: 100%; height: 320px;">
              <canvas id="chartTendenciaCanjes"></canvas>
            </div>
          </div>
        </div>

        <!-- Tabla de productos con estad√≠sticas -->
        <div style="background: #f9f9f9; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow-x: auto;">
          <h3 style="margin-top: 0; font-size: 1.1em;">Estad√≠sticas por Producto</h3>
          <table id="tablaEstadisticasProductos" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
            <thead>
              <tr style="background: #e8e8e8; border-bottom: 2px solid #d0d0d0;">
                <th style="padding: 12px; text-align: left;">Producto</th>
                <th style="padding: 12px; text-align: center;">Canjes</th>
                <th style="padding: 12px; text-align: center;">Puntos Usados</th>
                <th style="padding: 12px; text-align: center;">Promedio/Canje</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaEstadisticas">
              <tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">Cargando estad√≠sticas...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal de edici√≥n de perfil -->
  <div id="modalEditarPerfil" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button type="button" class="modal-close" aria-label="Cerrar">&times;</button>
      <div class="modal-header">
        <h2>Editar Perfil de la Tienda</h2>
      </div>
      <form id="formEditarPerfil" class="modal-body" style="display: block;">
        <label for="editNombreTienda">Nombre de la tienda:</label>
        <input type="text" id="editNombreTienda" required>
        
        <label for="editDireccionTienda">Direcci√≥n (si es f√≠sica):</label>
        <input type="text" id="editDireccionTienda">
        
        <label for="editTelefonoTienda">Datos de contacto:</label>
        <input type="text" id="editTelefonoTienda" required>
        
        <label for="editHorarioTienda">Horario de atenci√≥n:</label>
        <input type="text" id="editHorarioTienda">
        
        <label for="editResponsableTienda">Persona responsable:</label>
        <input type="text" id="editResponsableTienda">
      </form>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" id="btnCancelarEdicion">Cancelar</button>
        <button type="button" class="btn-primary" id="btnGuardarEdicion">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal de edici√≥n/eliminaci√≥n de producto -->
  <div id="modalProductoTienda" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button type="button" class="modal-close" aria-label="Cerrar">&times;</button>
      <div class="modal-header">
        <h2>Editar Producto</h2>
      </div>
      <div class="modal-body" style="display: block; grid-template-columns: 1fr;">
        <div id="productoTiendaInfo" style="display: flex; flex-direction: column; gap: 12px;">
          <div>
            <strong>Nombre:</strong>
            <input type="text" id="editProductoNombre" style="width: 100%; margin-top: 4px;">
          </div>
          <div>
            <strong>Descripci√≥n:</strong>
            <textarea id="editProductoDescripcion" rows="3" style="width: 100%; margin-top: 4px;"></textarea>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <strong>Costo (puntos):</strong>
              <input type="number" id="editProductoCosto" min="1" style="width: 100%; margin-top: 4px;">
            </div>
            <div>
              <strong>Stock:</strong>
              <input type="number" id="editProductoStock" min="0" style="width: 100%; margin-top: 4px;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <strong>Precio ($):</strong>
              <input type="number" id="editProductoPrecio" step="0.01" min="0" style="width: 100%; margin-top: 4px;">
            </div>
          <div>
            <strong>Imagen del producto:</strong>
            <input type="file" id="editProductoImagenFile" accept="image/*" style="margin-top:6px;">
            <div id="editProductoImagenPreview" style="margin-top:8px;"></div>
            <button type="button" id="editProductoImagenClear" class="btn-secondary" style="margin-top:6px; display:none;">Limpiar imagen</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" id="btnCancelarProducto">Cancelar</button>
        <button type="button" class="btn-secondary" id="btnEliminarProducto" style="background: #ef4444; color: white; border: none;">üóëÔ∏è Eliminar</button>
        <button type="button" class="btn-primary" id="btnGuardarProducto">Guardar cambios</button>
      </div>
    </div>
  </div>
</body>
</html>
