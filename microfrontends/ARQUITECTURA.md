# Diagrama de Arquitectura

## ๐๏ธ Arquitectura General

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       NAVEGADOR DEL USUARIO                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SHELL APP (React + Vite)                      โ
โ                   puerto 5173 - Contenedor                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                     HEADER & NAV                         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ              AUTH CONTEXT + EventBus ๐                  โ   โ
โ  โ  (Autenticaciรณn centralizada + Comunicaciรณn)             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ          โ
โ  โ Micro        โ  โ Micro        โ  โ Micro        โ          โ
โ  โ Historial    โ  โ Productos    โ  โ Canjes       โ          โ
โ  โ (Vue)        โ  โ (React)      โ  โ (Vue)        โ          โ
โ  โ :5174        โ  โ :5175        โ  โ :5176        โ          โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ          โ
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                    FOOTER                                โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ                โ                โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ      SUPABASE (Base de Datos Central)      โ
    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ  โ Tables:                                โโ
    โ  โ - profiles (usuarios)                  โโ
    โ  โ - products (productos)                 โโ
    โ  โ - stores (tiendas)                     โโ
    โ  โ - redemptions (canjes)                 โโ
    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ก EventBus - Flujo de Comunicaciรณn

```
INTEGRANTE 2 (Micro Productos)
         โ
         โ eventBus.emit('add-to-cart', {...})
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         EVENTBUS (centralizado)            โ
โ      en shell-app/src/utils/eventBus.js    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ eventBus.on('add-to-cart', callback)
         โ
INTEGRANTE 3 (Micro Canjes)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CarritoCanjes.vue                โ
โ - Agrega item                    โ
โ - Actualiza total                โ
โ - Emite 'canje-completado'       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
eventBus.emit('canje-completado', {...})
         โ
INTEGRANTE 1 (Micro Historial)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ HistorialCompras.vue             โ
โ - Escucha evento                 โ
โ - Actualiza lista en tiempo real โ
โ - Recarga desde Supabase         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Ciclo Completo de un Canje

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. USUARIO VE PRODUCTOS EN MICRO PRODUCTOS                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ CatalogoProductos.jsx                                       โ
โ โโ useProductos() โโโ productosService.js โโโ Supabase    โ
โ    โโ Carga: products + stores                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. USUARIO APLICA FILTROS                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ FiltrosCategoria.jsx + BuscadorProductos.jsx                โ
โ โโ useFiltros() โโโ Filtra array localmente                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. USUARIO AGREGA PRODUCTO AL CARRITO                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ CatalogoProductos.jsx - handleAgregarAlCarrito()            โ
โ โโ eventBus.emit('add-to-cart', {                          โ
โ      productoId, nombre, puntos, tienda, ...               โ
โ    })                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                    [NETWORK DELAY]
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. MICRO CANJES RECIBE EVENTO                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ CarritoCanjes.vue - onMounted()                             โ
โ eventBus.on('add-to-cart', (item) => {                     โ
โ   carritoStore.agregarAlCarrito(item)                      โ
โ })                                                          โ
โ โโ Actualiza UI del carrito                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5. USUARIO VE EL CARRITO                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ CarritoCanjes.vue muestra:                                  โ
โ - Items agregados                                           โ
โ - Total de puntos                                           โ
โ - Botรณn: "Proceder a Canje"                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 6. USUARIO CONFIRMA CANJE                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ConfirmacionCanje.vue - procesarCanje()                    โ
โ โโ Para cada item del carrito:                             โ
โ    โโ Validar puntos disponibles (ResumenPuntos.vue)       โ
โ    โโ POST a Supabase redemptions table                    โ
โ    โโ UPDATE profiles.puntos                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 7. NOTIFICAR A OTROS MICROFRONTENDS                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ConfirmacionCanje.vue - despuรฉs de INSERT exitoso          โ
โ โโ eventBus.emit('canje-completado', {                    โ
โ      usuario_id, puntos_usados, items, ...                โ
โ    })                                                       โ
โ โโ eventBus.emit('puntosActualizados', {                  โ
โ      usuarioId, nuevoSaldo                                 โ
โ    })                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                    [NETWORK DELAY]
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 8. MICRO HISTORIAL SE ACTUALIZA                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ HistorialCompras.vue - onMounted()                          โ
โ eventBus.on('canje-completado', async (datos) => {        โ
โ   // Actualizar store local                                โ
โ   historialStore.agregarAlHistorial(datos)                โ
โ   // Recargar desde BD                                      โ
โ   await historialService.cargarHistorial(...)              โ
โ })                                                          โ
โ โโ Nueva compra aparece en historial automรกticamente       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 9. ESTADรSTICAS SE ACTUALIZAN                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ EstadisticasPuntos.vue escucha:                             โ
โ - 'canje-completado' โ Recalcula stats                     โ
โ - 'puntosActualizados' โ Actualiza barra de puntos         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โ CANJE COMPLETADO - TODO SINCRONIZADO                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo de Autenticaciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Usuario en Login.jsx           โ
โ  (Shell App)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AuthService.signIn()           โ
โ  โโ Supabase Auth API           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AuthContext.jsx                โ
โ  โโ setUsuario(userData)        โ
โ  โโ StorageService.save()       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
eventBus.emit('usuario-sesion', {
  tipo: 'login',
  usuario: userData
})
           โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
โ                      โ                      โ                  โ
โ                      โ                      โ                  โ
Micro Historial   Micro Productos       Micro Canjes      Shell App
- Cargar data     - Cargar products     - Limpiar        - Mostrar
- Actualizar UI   - Mostrar catรกlogo    - Mostrar login  - Dashboard
```

---

## ๐ฆ Estructura de Datos - Flujo

```
USUARIO LOGUEA
    โ
SHELL APP AUTH
    โโ profiles{id, puntos, ...}
    โโ emite: usuario-sesion
    
    
USUARIO VE PRODUCTOS
    โ
MICRO PRODUCTOS carga
    โโ products{id, tienda_id, nombre, costo_puntos, ...}
    โโ stores{id, nombre, email, ...}
    โโ JOIN: products โ tienda โ stores
    

USUARIO AGREGA AL CARRITO
    โ
MICRO CANJES recibe
    โโ ItemCarrito{productoId, nombre, puntos, cantidad}
    โโ carritoStore.agregarItem()
    โโ Calcula: total = sum(item.puntos * item.cantidad)


USUARIO PROCESA CANJE
    โ
MICRO CANJES inserta en Supabase
    โโ INSERT INTO redemptions VALUES{
    โ     perfil_id,
    โ     producto_id,
    โ     puntos_usados,
    โ     estado: 'completado'
    โ  }
    โ
    โโ UPDATE profiles SET puntos = puntos - total
    

MICRO HISTORIAL SE ACTUALIZA
    โ
    โโ SELECT * FROM redemptions WHERE perfil_id = $1
    โโ JOIN con products para detalles
    โโ Muestra en HistorialCompras.vue
```

---

## ๐ฏ Mapeo Componentes โ Funciones

```
VANILLA JS          โ    VUE/REACT COMPONENT    โ    SERVICIO
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
mostrarHistorial()      HistorialCompras.vue        historialService.js
                        HistorialCanjes.vue
                        EstadisticasPuntos.vue

cargarTiendasYProd()    CatalogoProductos.jsx       productosService.js
                        BuscadorProductos.jsx
                        FiltrosCategoria.jsx

agregarAlCarrito()      CarritoCanjes.vue           canjeService.js
confirmarCompra()       ConfirmacionCanje.vue
                        ResumenPuntos.vue

aplicarFiltros()        FiltrosCategoria.jsx        useFiltros.js (hook)

buscarProductos()       BuscadorProductos.jsx       productosService.js

validarPuntos()         ResumenPuntos.vue           canjeService.js
                        ValidadorPuntos.vue
```

---

## ๐พ Estado Global vs Local

```
GLOBAL (Shell App + EventBus)
โโ Usuario autenticado
โโ Tokens de sesiรณn
โโ Informaciรณn de perfil

MICRO HISTORIAL (Pinia)
โโ historialStore
โ  โโ historial[]
โ  โโ estadรญsticas{}
โ  โโ filtros{}

MICRO PRODUCTOS (Context/Props)
โโ ProductosContext
โ  โโ productos[]
โ  โโ filtros{}
โ  โโ busqueda{}

MICRO CANJES (Pinia)
โโ carritoStore
โ  โโ carrito[]
โ  โโ total
โโ canjeStore
โ  โโ procesando
โ  โโ error
```

---

## ๐ Dependencias y Relaciones

```
SHELL APP
    โโ Proporciona: EventBus
    โโ Proporciona: AuthContext
    โโ Proporciona: supabaseClient
    โโ Mantiene: sesiรณn de usuario
    
        โ escucha de
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ                                  โ
        
MICRO PRODUCTOS (React)
    โโ Emite: add-to-cart
    โโ Escucha: usuario-sesion
    โโ Usa: productosService

        โ envรญa
        
MICRO CANJES (Vue)
    โโ Escucha: add-to-cart
    โโ Escucha: usuario-sesion
    โโ Emite: canje-completado
    โโ Emite: puntosActualizados
    โโ Usa: canjeService

        โ notifica
        
MICRO HISTORIAL (Vue)
    โโ Escucha: canje-completado
    โโ Escucha: puntosActualizados
    โโ Escucha: usuario-sesion
    โโ Usa: historialService
```

---

## ๐ Deployment (Arquitectura)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         SERVIDOR DE PRODUCCIรN              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                             โ
โ  /shell-app         (puerto 80 o 443)      โ
โ  โโ index.html                             โ
โ  โโ remoteEntry.js                         โ
โ  โโ assets/...                             โ
โ                                             โ
โ  /micro-historial   (puerto 3001)          โ
โ  โโ remoteEntry.js                         โ
โ  โโ assets/...                             โ
โ                                             โ
โ  /micro-productos   (puerto 3002)          โ
โ  โโ remoteEntry.js                         โ
โ  โโ assets/...                             โ
โ                                             โ
โ  /micro-canje       (puerto 3003)          โ
โ  โโ remoteEntry.js                         โ
โ  โโ assets/...                             โ
โ                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ      SUPABASE (BD centralizada)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**รltima actualizaciรณn**: Enero 2026
